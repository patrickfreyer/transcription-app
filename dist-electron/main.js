"use strict";const{app:$,BrowserWindow:G,ipcMain:d,dialog:z,shell:Z}=require("electron"),v=require("path"),j=require("openai"),c=require("fs"),V=require("os"),B=require("keytar"),ee=require("electron-store"),{registerAllHandlers:te}=require("./backend/handlers"),R="Audio Transcription App",W="openai-api-key",J=new ee({defaults:{transcripts:[],chatHistory:{},"summary-templates":[]}});process.on("uncaughtException",e=>{console.error("Uncaught Exception:",e),z.showErrorBox("Application Error",`An error occurred during startup:

${e.message}

Stack: ${e.stack}`)});let I,x,F,L=!1;try{console.log("=== FFmpeg Loading Debug Info ==="),console.log("Platform:",process.platform),console.log("Architecture:",process.arch),console.log("App path:",$.getAppPath()),console.log("Resource path:",process.resourcesPath),I=require("fluent-ffmpeg"),console.log("✓ fluent-ffmpeg loaded");try{if(x=require("@ffmpeg-installer/ffmpeg").path,x.includes("app.asar")&&!x.includes(".asar.unpacked")&&(x=x.replace("app.asar","app.asar.unpacked")),console.log("✓ ffmpeg-installer loaded"),console.log("FFmpeg path:",x),console.log("FFmpeg exists:",c.existsSync(x)),c.existsSync(x)){const t=c.statSync(x);console.log("FFmpeg is file:",t.isFile()),console.log("FFmpeg is directory:",t.isDirectory())}}catch(e){throw console.error("✗ Error loading ffmpeg-installer:",e.message),e}try{if(F=require("@ffprobe-installer/ffprobe").path,F.includes("app.asar")&&!F.includes(".asar.unpacked")&&(F=F.replace("app.asar","app.asar.unpacked")),console.log("✓ ffprobe-installer loaded"),console.log("FFprobe path:",F),console.log("FFprobe exists:",c.existsSync(F)),c.existsSync(F)){const t=c.statSync(F);console.log("FFprobe is file:",t.isFile()),console.log("FFprobe is directory:",t.isDirectory())}}catch(e){throw console.error("✗ Error loading ffprobe-installer:",e.message),e}I.setFfmpegPath(x),I.setFfprobePath(F),L=!0,console.log("✓ FFmpeg fully configured and available"),console.log("=================================")}catch(e){console.error("=== FFmpeg Loading Failed ==="),console.error("Error:",e.message),console.error("Stack:",e.stack),console.error("============================"),process.platform==="win32"&&z.showErrorBox("Large File Support Unavailable",`FFmpeg could not be loaded. Large file support (>25MB) will not work.

Error: ${e.message}

Files under 25MB will still work normally.`)}$.setName("Audio Transcription");let a;function X(e){return new Promise((t,s)=>{I.ffprobe(e,(n,r)=>{n?s(n):t(r.format.duration)})})}async function se(e){return new Promise((t,s)=>{const n=V.tmpdir(),r=v.join(n,`converted-${Date.now()}.mp3`);I(e).output(r).audioCodec("libmp3lame").audioBitrate("192k").audioFrequency(44100).on("end",()=>t(r)).on("error",o=>s(new Error(`Audio conversion failed: ${o.message}`))).run()})}async function re(e,t=20){try{const n=c.statSync(e).size/(1024*1024);if(n<=25)return[e];const r=await X(e),o=V.tmpdir(),p=v.join(o,`chunks-${Date.now()}`);c.mkdirSync(p,{recursive:!0});const i=Math.floor(r*t/n),w=Math.ceil(r/i),u=[];for(let k=0;k<w;k++){const g=k*i,A=v.join(p,`chunk-${k}.mp3`);await new Promise((E,m)=>{I(e).setStartTime(g).setDuration(i).output(A).audioCodec("libmp3lame").audioBitrate("128k").on("end",()=>E()).on("error",h=>m(h)).run()}),u.push(A)}return u}catch(s){throw new Error(`Failed to split audio: ${s.message}`)}}function q(e){const t=e.split(":"),s=parseInt(t[0]),n=parseInt(t[1]),r=t[2].split("."),o=parseInt(r[0]),p=parseInt(r[1]);return s*3600+n*60+o+p/1e3}function M(e){const t=Math.floor(e/3600),s=Math.floor(e%3600/60),n=Math.floor(e%60),r=Math.floor(e%1*1e3);return`${String(t).padStart(2,"0")}:${String(s).padStart(2,"0")}:${String(n).padStart(2,"0")}.${String(r).padStart(3,"0")}`}function ne(e,t){let s=`WEBVTT

`,n=1,r=0;for(let o=0;o<e.length;o++){const i=e[o].split(`
`);let w=!0,u=[];for(let k=0;k<i.length;k++){const g=i[k];if(w){if(g.trim()===""||g.startsWith("WEBVTT"))continue;w=!1}if(g.includes("-->")){const[A,E]=g.split("-->").map(b=>b.trim()),m=q(A)+r,h=q(E)+r;u.push(`${n}`),u.push(`${M(m)} --> ${M(h)}`),n++}else g.trim()===""?u.length>0&&(s+=u.join(`
`)+`

`,u=[]):g.match(/^\d+$/)||u.push(g)}u.length>0&&(s+=u.join(`
`)+`

`),o<t.length&&(r+=t[o])}return s}function U(e){try{if(e.length>0){const t=v.dirname(e[0]);e.forEach(s=>{c.existsSync(s)&&c.unlinkSync(s)}),c.existsSync(t)&&c.rmdirSync(t)}}catch(t){console.error("Error cleaning up chunks:",t)}}function Y(){const e=process.platform==="win32";process.platform,a=new G({width:1100,height:750,minWidth:900,minHeight:600,title:"Audio Transcription",webPreferences:{preload:v.join(__dirname,"preload.js"),nodeIntegration:!1,contextIsolation:!0},titleBarStyle:e?"hidden":"hiddenInset",frame:!e,backgroundColor:"#ffffff"}),process.env.VITE_DEV_SERVER_URL?a.loadURL(process.env.VITE_DEV_SERVER_URL):a.loadFile(v.join(__dirname,"dist/index.html")),a.webContents.on("did-finish-load",async()=>{try{await B.getPassword(R,W)?a.webContents.send("api-key-status","valid"):a.webContents.send("api-key-status","missing")}catch(t){console.error("Error checking API key on startup:",t),a.webContents.send("api-key-status","missing")}})}$.whenReady().then(Y);$.on("window-all-closed",()=>{process.platform!=="darwin"&&$.quit()});$.on("activate",()=>{G.getAllWindows().length===0&&Y()});d.handle("validate-api-key",async(e,t)=>{try{return await new j({apiKey:t}).models.list(),{success:!0,message:"API key is valid"}}catch(s){let n="Invalid API key";return s.status===401?n="Invalid API key. Please check your key and try again.":s.status===429?n="Rate limit exceeded. Please try again later.":s.message&&(n=s.message),{success:!1,error:n}}});d.handle("save-api-key",async(e,t)=>(global.apiKey=t,{success:!0}));d.handle("get-api-key",async()=>global.apiKey||null);d.handle("save-api-key-secure",async(e,t)=>{try{return await B.setPassword(R,W,t),console.log("✓ API key saved to secure storage"),{success:!0}}catch(s){return console.error("Failed to save API key:",s),{success:!1,error:s.message}}});d.handle("get-api-key-secure",async()=>{try{return{success:!0,apiKey:await B.getPassword(R,W)}}catch(e){return console.error("Failed to retrieve API key:",e),{success:!1,error:e.message}}});d.handle("delete-api-key-secure",async()=>{try{const e=await B.deletePassword(R,W);return console.log("✓ API key deleted from secure storage"),{success:e}}catch(e){return console.error("Failed to delete API key:",e),{success:!1,error:e.message}}});d.handle("get-templates",async()=>{try{const e=J.get("summary-templates",[]);return console.log("✓ Loaded summary templates from storage"),{success:!0,templates:e}}catch(e){return console.error("Failed to load templates:",e),{success:!1,error:e.message,templates:[]}}});d.handle("save-templates",async(e,t)=>{try{return J.set("summary-templates",t),console.log("✓ Saved summary templates to storage"),{success:!0}}catch(s){return console.error("Failed to save templates:",s),{success:!1,error:s.message}}});d.handle("save-file-to-temp",async(e,t,s)=>{try{const n=V.tmpdir(),r=v.basename(s),o=v.join(n,`upload-${Date.now()}-${r}`);return console.log("Saving file to temp:",o),c.writeFileSync(o,Buffer.from(t)),{success:!0,filePath:o}}catch(n){return console.error("Failed to save file to temp:",n),{success:!1,error:n.message}}});d.on("window-minimize",()=>{a&&a.minimize()});d.on("window-maximize",()=>{a&&(a.isMaximized()?a.unmaximize():a.maximize())});d.on("window-close",()=>{a&&a.close()});d.handle("navigate",async(e,t)=>{a.loadFile(`src/${t}.html`)});d.handle("save-recording",async(e,t)=>{try{const s=V.tmpdir(),n=v.join(s,`recording-${Date.now()}.webm`),r=Buffer.from(t);return c.writeFileSync(n,r),{success:!0,filePath:n}}catch(s){return{success:!1,error:s.message||"Failed to save recording"}}});function N(e){const s=c.readFileSync(e).toString("base64"),n=v.extname(e).toLowerCase();return`data:${{".mp3":"audio/mpeg",".wav":"audio/wav",".m4a":"audio/mp4",".webm":"audio/webm",".mp4":"audio/mp4",".mpeg":"audio/mpeg",".mpga":"audio/mpeg"}[n]||"audio/mpeg"};base64,${s}`}function H(e){return!e||!e.text?`WEBVTT

`+(e?.text||""):`WEBVTT

`+e.text}function K(e){if(!e||!e.segments)return`WEBVTT

`;let t=`WEBVTT

`,s=1;for(const n of e.segments){const r=M(n.start),o=M(n.end),p=n.speaker||"Unknown",i=n.text||"";t+=`${s}
`,t+=`${r} --> ${o}
`,t+=`[${p}] ${i}

`,s++}return t}function O(e){return e?e.split(`
`).filter(t=>{const s=t.trim();return s!==""&&!s.startsWith("WEBVTT")&&!s.includes("-->")&&!/^\d+$/.test(s)}).join(`
`).trim():""}d.handle("transcribe-audio",async(e,t,s,n)=>{let r=[],o=null;const p=typeof n=="string",i=p?"whisper-1":n?.model||"gpt-4o-transcribe",w=p?n:n?.prompt||null,u=p?null:n?.speakers||null;try{const k=new j({apiKey:s});let g=t;if(t.toLowerCase().endsWith(".webm")){if(!L)return{success:!1,error:`WebM recordings require FFmpeg for conversion, which could not be loaded on this system.

Please try uploading an MP3 or WAV file instead, or try re-downloading the application.`};a&&!a.isDestroyed()&&a.webContents.send("transcription-progress",{status:"converting",message:"Converting recording to MP3 format..."}),o=await se(t),g=o}const E=c.statSync(g).size/(1024*1024);if(E>25){if(!L)return o&&c.existsSync(o)&&c.unlinkSync(o),{success:!1,error:`File size is ${E.toFixed(1)}MB, which exceeds the 25MB API limit.

Large file support requires FFmpeg, which could not be loaded on this system.

Please use a file smaller than 25MB, or try re-downloading the application.`};a&&!a.isDestroyed()&&a.webContents.send("transcription-progress",{status:"splitting",message:"Splitting large audio file into chunks..."}),r=await re(g,20);const m=[];for(const l of r){const T=await X(l);m.push(T)}const h=[];for(let l=0;l<r.length;l++){const T=r[l];a&&!a.isDestroyed()&&a.webContents.send("transcription-progress",{status:"transcribing",message:`Transcribing chunk ${l+1} of ${r.length}...`,current:l+1,total:r.length});let y=null;if(l===0&&w)y=w;else if(l>0&&h[l-1]){const D=h[l-1].split(`
`).filter(P=>!P.includes("-->")&&!P.startsWith("WEBVTT")&&P.trim()!==""&&!/^\d+$/.test(P.trim())).join(" ").trim().slice(-200);w?y=`${w}

Previous context: ${D}`:y=D}try{const f={file:c.createReadStream(T),model:i};if(i==="whisper-1")f.response_format="vtt",y&&(f.prompt=y);else if(i==="gpt-4o-transcribe")f.response_format="json",y&&(f.prompt=y);else if(i==="gpt-4o-transcribe-diarize"&&(f.response_format="diarized_json",f.chunking_strategy="auto",u&&u.length>0&&l===0)){const S=[],D=[];for(const P of u){S.push(P.name);const Q=N(P.path);D.push(Q)}f.known_speaker_names=S,f.known_speaker_references=D}const C=await k.audio.transcriptions.create(f);h.push(C)}catch(f){console.error(`Error transcribing chunk ${l+1}:`,f),h.push(i==="whisper-1"?"":{text:""})}}a&&!a.isDestroyed()&&a.webContents.send("transcription-progress",{status:"combining",message:"Combining transcripts..."});let b,_=!1;if(i==="whisper-1")b=ne(h,m);else if(i==="gpt-4o-transcribe"){const l=h.map(T=>T.text||"").join(" ");b=H({text:l})}else if(i==="gpt-4o-transcribe-diarize"){let l=[],T=0;for(let y=0;y<h.length;y++){const f=h[y];if(f.segments){const C=f.segments.map(S=>({...S,start:S.start+T,end:S.end+T}));l=l.concat(C)}y<m.length&&(T+=m[y])}b=K({segments:l}),_=!0}return U(r),o&&c.existsSync(o)&&c.unlinkSync(o),{success:!0,text:O(b),transcript:b,chunked:!0,totalChunks:r.length,isDiarized:_}}else{const m={file:c.createReadStream(g),model:i};if(i==="whisper-1")m.response_format="vtt",w&&(m.prompt=w);else if(i==="gpt-4o-transcribe")m.response_format="json",w&&(m.prompt=w);else if(i==="gpt-4o-transcribe-diarize"&&(m.response_format="diarized_json",m.chunking_strategy="auto",u&&u.length>0)){const l=[],T=[];for(const y of u){l.push(y.name);const f=N(y.path);T.push(f)}m.known_speaker_names=l,m.known_speaker_references=T}const h=await k.audio.transcriptions.create(m);let b,_=!1;return i==="whisper-1"?b=h:i==="gpt-4o-transcribe"?b=H(h):i==="gpt-4o-transcribe-diarize"&&(b=K(h),_=!0),o&&c.existsSync(o)&&c.unlinkSync(o),{success:!0,text:O(b),transcript:b,chunked:!1,isDiarized:_}}}catch(k){if(r.length>0&&U(r),o&&c.existsSync(o))try{c.unlinkSync(o)}catch(g){console.error("Error cleaning up converted file:",g)}return{success:!1,error:k.message||"Transcription failed"}}});d.handle("generate-summary",async(e,t,s,n)=>{try{const r=new j({apiKey:n});console.log("Generating summary with OpenAI...");const p=(await r.chat.completions.create({model:"gpt-4o",messages:[{role:"system",content:"You are a helpful assistant that creates summaries of transcriptions based on user instructions."},{role:"user",content:`Here is a transcription:

${t}

${s}`}],temperature:.3})).choices[0]?.message?.content;if(!p)throw new Error("No summary generated");return console.log("✓ Summary generated successfully"),{success:!0,summary:p.trim()}}catch(r){return console.error("Summary generation error:",r),{success:!1,error:r.message||"Summary generation failed"}}});te();d.handle("open-external",async(e,t)=>{try{const s=new URL(t);return s.protocol==="http:"||s.protocol==="https:"?(await Z.openExternal(t),{success:!0}):(console.error("Invalid protocol:",s.protocol),{success:!1,error:"Only HTTP and HTTPS URLs are allowed"})}catch(s){return console.error("Error opening external URL:",s),{success:!1,error:s.message}}});d.handle("save-transcript",async(e,t,s,n)=>{try{const r={txt:{name:"Text File",extensions:["txt"]},vtt:{name:"WebVTT Subtitle",extensions:["vtt"]},md:{name:"Markdown",extensions:["md"]},pdf:{name:"PDF Document",extensions:["pdf"]}},o=r[s]||r.txt,p=await z.showSaveDialog(a,{title:"Save Transcript",defaultPath:v.join($.getPath("documents"),`${n}.${o.extensions[0]}`),filters:[{name:o.name,extensions:o.extensions},{name:"All Files",extensions:["*"]}]});if(p.canceled)return{success:!1,cancelled:!0};if(s==="pdf")throw new Error("PDF export not yet implemented. Please use TXT, VTT, or Markdown format.");let i=t;return s==="md"&&(i=`# Transcript

${t}`),c.writeFileSync(p.filePath,i,"utf8"),console.log(`✓ Transcript saved as ${s.toUpperCase()}: ${p.filePath}`),{success:!0,filePath:p.filePath}}catch(r){return console.error("Save transcript error:",r),{success:!1,error:r.message||"Failed to save file"}}});
