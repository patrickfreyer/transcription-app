<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Meeting Summary - Audio Transcription</title>
    <link rel="stylesheet" href="styles.css" />
    <!-- Load marked.js for markdown rendering -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <!-- Load mermaid.js for diagram rendering -->
    <script type="module">
      import mermaid from 'https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.esm.min.mjs';
      mermaid.initialize({
        startOnLoad: false,
        theme: 'default',
        themeVariables: {
          primaryColor: '#007aff',
          primaryTextColor: '#1d1d1f',
          primaryBorderColor: '#d2d2d7',
          lineColor: '#6e6e73',
          secondaryColor: '#f5f5f7',
          tertiaryColor: '#fbfbfd'
        }
      });
      window.mermaid = mermaid;
    </script>
  </head>
  <body>
    <div class="container summary-container">
      <h1>Meeting Summary</h1>
      <p class="subtitle" id="file-name-subtitle"></p>

      <!-- Loading State -->
      <div class="loading-state" id="loading-state" style="display: none">
        <div class="loading-spinner"></div>
        <p class="loading-text">Generating meeting summary...</p>
      </div>

      <!-- Summary Content -->
      <div class="summary-content" id="summary-content"></div>

      <!-- Action Buttons -->
      <div class="button-group summary-actions" id="summary-actions" style="display: none">
        <button class="btn" id="save-btn">Save as Markdown</button>
        <button class="btn btn-typora" id="save-typora-btn">Save & Open in Typora</button>
      </div>

      <div class="button-group summary-navigation">
        <button class="btn btn-secondary" id="view-transcript-btn">View Transcript</button>
        <button class="btn btn-secondary" id="new-transcription-btn">New</button>
      </div>

      <div
        style="
          text-align: center;
          margin-top: 20px;
          color: #48bb78;
          font-size: 14px;
          font-weight: 600;
          display: none;
        "
        id="save-success"
      >
        âœ“ Saved successfully!
      </div>

      <footer class="attribution">
        Created by <a href="https://patrickfreyer.com" target="_blank">Patrick C. Freyer</a>
        <br>
        <a href="mailto:freyer.patrick@bcg.com">freyer.patrick@bcg.com</a>
      </footer>
    </div>

    <script>
      const summaryContent = document.getElementById('summary-content');
      const fileNameSubtitle = document.getElementById('file-name-subtitle');
      const loadingState = document.getElementById('loading-state');
      const summaryActions = document.getElementById('summary-actions');
      const saveBtnElement = document.getElementById('save-btn');
      const saveTyporaBtnElement = document.getElementById('save-typora-btn');
      const viewTranscriptBtn = document.getElementById('view-transcript-btn');
      const newTranscriptionBtn = document.getElementById('new-transcription-btn');
      const saveSuccess = document.getElementById('save-success');

      let currentSummaryMarkdown = '';
      let fileName = '';

      // Load summary from localStorage or generate it
      async function loadSummary() {
        const existingSummary = localStorage.getItem('meetingSummary');
        const transcript = localStorage.getItem('transcript');
        fileName = localStorage.getItem('fileName') || 'meeting';

        if (fileNameSubtitle) {
          fileNameSubtitle.textContent = `File: ${fileName}`;
        }

        if (existingSummary) {
          // Display existing summary
          displaySummary(existingSummary);
        } else if (transcript) {
          // Generate new summary
          await generateSummary(transcript);
        } else {
          summaryContent.innerHTML = `
            <div style="text-align: center; color: #86868b; padding: 40px 0;">
              No transcript available. Please transcribe an audio file first.
            </div>
          `;
        }
      }

      // Generate summary using OpenAI
      async function generateSummary(transcript) {
        try {
          loadingState.style.display = 'block';
          summaryContent.style.display = 'none';
          summaryActions.style.display = 'none';

          const apiKey = await window.electron.getApiKey();
          if (!apiKey) {
            throw new Error('API key not found');
          }

          const result = await window.electron.generateMeetingSummary(
            transcript,
            fileName,
            apiKey
          );

          if (result.success) {
            // Store summary for future use
            localStorage.setItem('meetingSummary', result.summary);
            displaySummary(result.summary);
          } else {
            throw new Error(result.error);
          }
        } catch (error) {
          loadingState.style.display = 'none';
          summaryContent.style.display = 'block';
          summaryContent.innerHTML = `
            <div style="text-align: center; color: #ff3b30; padding: 40px 0;">
              <strong>Failed to generate summary</strong><br>
              <span style="font-size: 14px;">${error.message}</span><br><br>
              <button class="btn btn-secondary" onclick="location.reload()">Try Again</button>
            </div>
          `;
        }
      }

      // Display summary with markdown and mermaid rendering
      async function displaySummary(markdown) {
        currentSummaryMarkdown = markdown;

        loadingState.style.display = 'none';
        summaryContent.style.display = 'block';
        summaryActions.style.display = 'flex';

        // Parse markdown to HTML
        const htmlContent = marked.parse(markdown);

        // Set the HTML content
        summaryContent.innerHTML = htmlContent;

        // Render mermaid diagrams
        if (window.mermaid) {
          try {
            // Find all mermaid code blocks
            const mermaidBlocks = summaryContent.querySelectorAll('pre code.language-mermaid');

            for (let i = 0; i < mermaidBlocks.length; i++) {
              const block = mermaidBlocks[i];
              const code = block.textContent;

              // Create a container for the mermaid diagram
              const container = document.createElement('div');
              container.className = 'mermaid-container';
              container.id = `mermaid-${i}`;

              // Replace the code block with the container
              block.parentElement.replaceWith(container);

              // Render the diagram
              const { svg } = await window.mermaid.render(`mermaid-diagram-${i}`, code);
              container.innerHTML = svg;
            }
          } catch (error) {
            console.error('Error rendering mermaid diagrams:', error);
          }
        }
      }

      // Listen for summary progress updates
      window.electron.onSummaryProgress((data) => {
        if (data.status === 'generating') {
          const loadingText = document.querySelector('.loading-text');
          if (loadingText) {
            loadingText.textContent = data.message || 'Generating meeting summary...';
          }
        }
      });

      // Save summary
      saveBtnElement.addEventListener('click', async () => {
        try {
          const result = await window.electron.saveSummary(
            currentSummaryMarkdown,
            fileName,
            false
          );

          if (result.success) {
            saveSuccess.style.display = 'block';
            setTimeout(() => {
              saveSuccess.style.display = 'none';
            }, 2000);
          }
        } catch (error) {
          console.error('Failed to save:', error);
        }
      });

      // Save and open in Typora
      saveTyporaBtnElement.addEventListener('click', async () => {
        try {
          const result = await window.electron.saveSummary(
            currentSummaryMarkdown,
            fileName,
            true
          );

          if (result.success) {
            saveSuccess.style.display = 'block';
            setTimeout(() => {
              saveSuccess.style.display = 'none';
            }, 2000);
          }
        } catch (error) {
          console.error('Failed to save:', error);
        }
      });

      // View transcript
      viewTranscriptBtn.addEventListener('click', () => {
        window.electron.navigate('transcript');
      });

      // New transcription
      newTranscriptionBtn.addEventListener('click', () => {
        // Clear localStorage
        localStorage.removeItem('transcript');
        localStorage.removeItem('fileName');
        localStorage.removeItem('isDiarized');
        localStorage.removeItem('transcriptModel');
        localStorage.removeItem('transcriptInfo');
        localStorage.removeItem('meetingSummary');

        // Navigate back to upload screen
        window.electron.navigate('upload');
      });

      // Initialize
      loadSummary();
    </script>
  </body>
</html>
